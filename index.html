<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>DNM</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --bg: #d4d0c8; --win-blue: #000080; --text: #000; }
        .dark { --bg: #222; --win-blue: #444; --text: #eee; }
        body { font-family: "Tahoma", sans-serif; background: #008080; margin: 0; height: 100vh; display: flex; flex-direction: column; color: var(--text); overflow: hidden; }
        .window { background: var(--bg); border: 2px solid; border-color: #fff #808080 #808080 #fff; width: 100%; height: 100%; display: flex; flex-direction: column; }
        .title-bar { background: linear-gradient(90deg, var(--win-blue), #0821d2); color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #auth-form, #settings-screen { padding: 20px; display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; }
        .warning-box { background: #ffffe1; border: 1px solid #808080; padding: 10px; font-size: 12px; color: #800000; }
        input, textarea { border: 2px inset #fff; padding: 12px; background: white; font-size: 16px; width: 100%; color: #000; }
        #chat-window { display: none; flex-direction: column; height: 100%; }
        #messages { flex: 1; background: white; margin: 5px; border: 2px inset #808080; overflow-y: auto; padding: 10px; color: #000; }
        .msg { margin-bottom: 12px; font-size: 14px; border-bottom: 1px dotted #ccc; padding-bottom: 5px; }
        .msg-tools { font-size: 10px; margin-top: 5px; }
        .msg-tools span { cursor: pointer; color: blue; text-decoration: underline; margin-right: 10px; }
        .media { max-width: 100%; border-radius: 4px; margin-top: 5px; border: 1px solid #888; }
        .controls { padding: 8px; background: var(--bg); border-top: 2px solid #808080; }
        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        button { background: var(--bg); border: 2px solid; border-color: #fff #808080 #808080 #fff; padding: 10px; font-weight: bold; cursor: pointer; color: #000; }
        .dark button { color: #000; }
        button:active { border-color: #808080 #fff #fff #808080; }
        #settings-screen { display: none; position: absolute; top: 40px; left: 0; width: 100%; height: calc(100% - 40px); z-index: 10; background: var(--bg); }
    </style>
</head>
<body>

<div class="window">
    <div class="title-bar">
        <span>üåº DNM v1.0 (P2P)</span>
        <div style="display: flex; gap: 10px;">
            <span id="set-btn" onclick="toggleSettings()" style="display:none; cursor:pointer;">‚öôÔ∏è</span>
            <span onclick="location.reload()" style="cursor:pointer;">‚úï</span>
        </div>
    </div>

    <div id="auth-form">
        <div class="warning-box">
            <strong>DNM (Decentralized Network Messenger)</strong><br>
            P2P-—Å–µ—Ç—å: —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ú–∞–∫—Å. —Ñ–∞–π–ª: 1–ú–ë. –í–∞—à TAG ‚Äî –∫–ª—é—á –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏.
        </div>
        <input type="text" id="name" placeholder="Name (–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è)">
        <input type="text" id="open-tag" placeholder="OPEN-TAG (ID –∫–æ–º–Ω–∞—Ç—ã)">
        <input type="password" id="tag" placeholder="TAG (–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)">
        <button onclick="startApp()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
    </div>

    <div id="settings-screen">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ DNM</h3>
        <button onclick="document.body.classList.toggle('dark')">üåó –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</button>
        <button onclick="clearHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω</button>
        <button onclick="toggleSettings()">üîô –ù–∞–∑–∞–¥</button>
    </div>

    <div id="chat-window">
        <div id="messages"></div>
        <div class="controls">
            <textarea id="text-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <div class="btns">
                <button onclick="sendMsg()">SEND</button>
                <button onclick="document.getElementById('file').click()">CLIP</button>
            </div>
            <input type="file" id="file" style="display:none" onchange="sendFile()">
        </div>
    </div>
</div>

<audio id="ooh" src="https://www.soundboard.com/handler/DownLoadTrack.ashx?cliptoken=66738981-d703-4927-993d-d40026e0e643"></audio>

<script>
    let gun, room, userConfig = {};
    const ooh = document.getElementById('ooh');

    function toggleSettings() {
        const s = document.getElementById('settings-screen');
        s.style.display = s.style.display === 'flex' ? 'none' : 'flex';
    }

    function clearHistory() {
        document.getElementById('messages').innerHTML = '';
        toggleSettings();
    }

    function startApp() {
        userConfig.name = document.getElementById('name').value;
        userConfig.room = document.getElementById('open-tag').value;
        userConfig.tag = document.getElementById('tag').value;
        if(!userConfig.name || !userConfig.room || !userConfig.tag) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");
        
        gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://libgun.herokuapp.com/gun']);
        room = gun.get('dnm_p2p_v1_' + userConfig.room);
        
        document.getElementById('auth-form').style.display = 'none';
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('set-btn').style.display = 'inline';
        listenMessages();
    }

    function encrypt(d) { return CryptoJS.AES.encrypt(d, userConfig.tag).toString(); }
    function decrypt(d) {
        try { const b = CryptoJS.AES.decrypt(d, userConfig.tag); return b.toString(CryptoJS.enc.Utf8); } 
        catch(e) { return null; }
    }

    function sendMsg() {
        const t = document.getElementById('text-input').value;
        if(!t.trim()) return;
        room.set({ name: userConfig.name, msg: encrypt(t), time: Date.now(), type: 'text' });
        document.getElementById('text-input').value = "";
    }

    function sendFile() {
        const f = document.getElementById('file').files[0];
        if(!f || f.size > 1000000) return alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (>1–ú–ë)");
        const r = new FileReader();
        r.onload = (e) => {
            room.set({ name: userConfig.name, msg: encrypt("–§–∞–π–ª: "+f.name), fileData: encrypt(e.target.result), fileType: f.type, time: Date.now(), type: 'media' });
        };
        r.readAsDataURL(f);
    }

    function tr(t) {
        window.open(`https://translate.google.com/?sl=auto&tl=ru&text=${encodeURIComponent(t)}&op=translate`, '_blank');
    }

    function listenMessages() {
        const mDiv = document.getElementById('messages');
        const seen = new Set();
        room.map().once((d, id) => {
            if(!d || seen.has(id)) return;
            seen.add(id);
            const dt = decrypt(d.msg);
            if(dt === null) return;
            if(d.name !== userConfig.name) ooh.play().catch(()=>{});
            const v = document.createElement('div');
            v.className = 'msg';
            let c = `<b>${d.name}:</b> ${dt}<div class="msg-tools"><span onclick="tr('${dt.replace(/'/g,"")}')">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</span></div>`;
            if(d.type === 'media' && d.fileData) {
                const fs = decrypt(d.fileData);
                if(d.fileType.startsWith('image')) c += `<img src="${fs}" class="media">`;
                else if(d.fileType.startsWith('video')) c += `<video src="${fs}" controls class="media"></video>`;
                else c += `<br><a href="${fs}" download="file" style="color:blue">üíæ –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>`;
            }
            v.innerHTML = c;
            mDiv.appendChild(v);
            mDiv.scrollTop = mDiv.scrollHeight;
        });
    }
</script>
</body>
</html>
