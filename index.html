<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DNM</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --bg: #d4d0c8; --win: #000080; --text: #000; --msg: #fff; --btn: #ccc; }
        .dark { --bg: #2b2b2b; --win: #1a1a1a; --text: #efefef; --msg: #3c3c3c; --btn: #4a4a4a; }
        body { font-family: "Tahoma", sans-serif; background: #008080; margin: 0; height: 100vh; color: var(--text); overflow: hidden; display: flex; justify-content: center; }
        .window { background: var(--bg); border: 2px solid; border-color: #fff #808080 #808080 #fff; width: 100%; max-width: 600px; height: 100%; display: flex; flex-direction: column; }
        .title-bar { background: linear-gradient(90deg, var(--win), #0821d2); color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        #auth-form, #main-ui { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #auth-form { padding: 20px; gap: 10px; }
        #contacts-bar { background: var(--bg); border-bottom: 2px solid #808080; padding: 5px; display: flex; gap: 5px; overflow-x: auto; min-height: 45px; }
        .tab { padding: 8px 12px; background: var(--btn); border: 1px solid #888; cursor: pointer; font-size: 12px; white-space: nowrap; color: var(--text); }
        .tab.active { background: #27ae60; color: white; font-weight: bold; }
        input, textarea { border: 2px inset #fff; padding: 12px; background: white; font-size: 16px; width: 100%; color: #000; outline: none; }
        .dark input, .dark textarea { background: #444; color: #fff; border-color: #555; }
        #chat-window { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        #messages { flex: 1; background: var(--msg); margin: 5px; border: 2px inset #808080; overflow-y: auto; padding: 10px; }
        .msg { margin-bottom: 12px; font-size: 14px; padding: 8px; border-bottom: 1px solid rgba(128,128,128,0.2); }
        .msg b { color: #27ae60; }
        .controls { padding: 10px; background: var(--bg); border-top: 1px solid #808080; }
        .btns { display: flex; gap: 5px; margin-top: 5px; }
        button { background: var(--btn); border: 2px solid; border-color: #fff #808080 #808080 #fff; padding: 12px; font-weight: bold; cursor: pointer; color: var(--text); flex: 1; }
        button:active { border-color: #808080 #fff #fff #808080; }
        #search-box { padding: 8px; background: rgba(0,0,0,0.1); display: flex; gap: 5px; }
    </style>
</head>
<body>
<div class="window">
    <div class="title-bar">
        <span>üåº DNM</span>
        <div style="display:flex; gap:15px">
            <span onclick="document.body.classList.toggle('dark')" style="cursor:pointer">üåì</span>
            <span onclick="location.reload()" style="cursor:pointer">‚úï</span>
        </div>
    </div>
    <div id="auth-form">
        <input type="text" id="my-name" placeholder="–ò–º—è">
        <input type="text" id="my-ot" placeholder="–í–∞—à OPEN-TAG">
        <input type="password" id="my-tag" placeholder="–í–∞—à TAG">
        <button onclick="login()">–í–û–ô–¢–ò</button>
    </div>
    <div id="main-ui" style="display:none">
        <div id="search-box">
            <input type="text" id="search-u" placeholder="–ü–æ–∏—Å–∫ –¥—Ä—É–≥–∞ –ø–æ OPEN-TAG">
            <button onclick="startChat()" style="flex:0">–ß–ê–¢</button>
        </div>
        <div id="contacts-bar"></div>
        <div id="chat-window">
            <div id="messages"></div>
            <div class="controls">
                <textarea id="text-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                <div class="btns">
                    <button onclick="sendMsg()" style="flex:2; background:#27ae60; color:white">–û–¢–ü–†–ê–í–ò–¢–¨</button>
                    <button onclick="document.getElementById('file').click()">–§–ê–ô–õ</button>
                </div>
                <input type="file" id="file" style="display:none" onchange="sendFile()">
            </div>
        </div>
    </div>
</div>
<audio id="ooh" src="https://www.soundboard.com/handler/DownLoadTrack.ashx?cliptoken=66738981-d703-4927-993d-d40026e0e643"></audio>
<script>
    let gun, user = {}, cur = null, chats = {};
    const ooh = document.getElementById('ooh');
    function login() {
        user.name = document.getElementById('my-name').value;
        user.ot = document.getElementById('my-ot').value.trim();
        user.tag = document.getElementById('my-tag').value;
        if(!user.name || !user.ot || !user.tag) return;
        gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://libgun.herokuapp.com/gun']);
        document.getElementById('auth-form').style.display = 'none';
        document.getElementById('main-ui').style.display = 'flex';
        switchChat('global');
    }
    function startChat() {
        const t = document.getElementById('search-u').value.trim();
        if(t && t !== user.ot) switchChat(t);
    }
    function getID(t) {
        if(t === 'global') return 'dnm_g_v3';
        const p = [user.ot, t].sort();
        return 'dnm_p_' + p[0] + '_' + p[1];
    }
    function switchChat(t) {
        cur = t;
        if(!chats[t]) {
            chats[t] = true;
            const b = document.createElement('div');
            b.className = 'tab';
            b.id = 'tab-' + t;
            b.innerText = t === 'global' ? '–û–ë–©–ò–ô' : '@' + t;
            b.onclick = () => switchChat(t);
            document.getElementById('contacts-bar').appendChild(b);
        }
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('messages').innerHTML = '';
        listen(getID(t));
    }
    function enc(d) { return CryptoJS.AES.encrypt(d, user.tag).toString(); }
    function dec(d) {
        try { return CryptoJS.AES.decrypt(d, user.tag).toString(CryptoJS.enc.Utf8) || null; } 
        catch(e) { return null; }
    }
    function sendMsg() {
        const i = document.getElementById('text-input');
        if(!i.value.trim()) return;
        gun.get(getID(cur)).set({ n: user.name, f: user.ot, m: enc(i.value), t: Date.now() });
        i.value = "";
    }
    function sendFile() {
        const f = document.getElementById('file').files[0];
        if(!f || f.size > 1000000) return;
        const r = new FileReader();
        r.onload = (e) => {
            gun.get(getID(cur)).set({ n: user.name, f: user.ot, m: enc("File: "+f.name), d: enc(e.target.result), type: f.type, t: Date.now() });
        };
        r.readAsDataURL(f);
    }
    function listen(id) {
        const box = document.getElementById('messages');
        const s = new Set();
        gun.get(id).map().once((d, rid) => {
            if(!d || s.has(rid)) return;
            const m = dec(d.m);
            if(m === null && id !== 'dnm_g_v3') return;
            s.add(rid);
            if(d.f !== user.ot) ooh.play().catch(()=>{});
            const v = document.createElement('div');
            v.className = 'msg';
            const txt = m || "[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ]";
            let html = `<b>${d.n}:</b> ${txt}`;
            if(d.d) {
                const src = dec(d.d);
                if(d.type.includes('image')) html += `<br><img src="${src}" style="max-width:100%">`;
                else if(d.type.includes('video')) html += `<br><video src="${src}" controls style="max-width:100%"></video>`;
                else html += `<br><a href="${src}" download style="color:blue">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>`;
            }
            v.innerHTML = html;
            box.appendChild(v);
            box.scrollTop = box.scrollHeight;
        });
    }
</script>
</body>
</html>
