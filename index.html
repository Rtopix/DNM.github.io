<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DNM - Private Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --bg: #d4d0c8; --win-blue: #000080; --text: #000; --msg-bg: #fff; --accent: #27ae60; }
        .dark { --bg: #1e1e1e; --win-blue: #2d2d2d; --text: #e0e0e0; --msg-bg: #2b2b2b; --accent: #34d399; }
        
        body { font-family: "Tahoma", sans-serif; background: #008080; margin: 0; height: 100vh; color: var(--text); overflow: hidden; display: flex; justify-content: center; }
        .window { background: var(--bg); border: 2px solid; border-color: #fff #808080 #808080 #fff; width: 100%; max-width: 600px; height: 100%; display: flex; flex-direction: column; position: relative; }
        
        .title-bar { background: linear-gradient(90deg, var(--win-blue), #0821d2); color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        #auth-form, #main-ui { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #auth-form { padding: 20px; gap: 10px; }
        
        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ / –ü–æ–∏—Å–∫ */
        #contacts-bar { background: var(--bg); border-bottom: 2px solid #808080; padding: 5px; display: flex; gap: 5px; overflow-x: auto; }
        .contact-tab { padding: 8px 15px; background: #bbb; border: 1px solid #888; cursor: pointer; font-size: 12px; white-space: nowrap; }
        .contact-tab.active { background: var(--accent); color: white; border-bottom: none; font-weight: bold; }

        input, textarea { border: 2px inset #fff; padding: 12px; background: white; font-size: 16px; width: 100%; color: #000; }
        .dark input, .dark textarea { background: #333; color: #fff; border-color: #444; }

        /* –ß–∞—Ç */
        #chat-window { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        #messages { flex: 1; background: var(--msg-bg); margin: 5px; border: 2px inset #808080; overflow-y: auto; padding: 10px; }
        
        .msg { margin-bottom: 12px; font-size: 14px; padding: 8px; border-radius: 4px; background: rgba(0,0,0,0.05); }
        .dark .msg { background: rgba(255,255,255,0.05); }
        .msg b { color: var(--accent); }

        .controls { padding: 10px; background: var(--bg); border-top: 2px solid #808080; }
        .btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 5px; }
        
        button { background: #ccc; border: 2px solid; border-color: #fff #808080 #808080 #fff; padding: 10px; font-weight: bold; cursor: pointer; }
        .dark button { background: #444; color: white; border-color: #666 #222 #222 #666; }
        
        #search-box { padding: 10px; background: rgba(0,0,0,0.1); display: flex; gap: 5px; }
    </style>
</head>
<body>

<div class="window">
    <div class="title-bar">
        <span>üåº DNM PRIVATE</span>
        <div style="display:flex; gap:10px">
            <span onclick="document.body.classList.toggle('dark')" style="cursor:pointer">üåì</span>
            <span onclick="location.reload()" style="cursor:pointer">‚úï</span>
        </div>
    </div>

    <div id="auth-form">
        <input type="text" id="my-name" placeholder="–í–∞—à–µ –ò–º—è">
        <input type="text" id="my-opentag" placeholder="–í–∞—à OPEN-TAG (–í–∞—à ID –¥–ª—è –ø–æ–∏—Å–∫–∞)">
        <input type="password" id="my-tag" placeholder="–í–∞—à TAG (–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)">
        <button onclick="login()">–í–û–ô–¢–ò –í –°–ï–¢–¨</button>
    </div>

    <div id="main-ui" style="display:none">
        <div id="search-box">
            <input type="text" id="search-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ OPEN-TAG...">
            <button onclick="startPrivateChat()">–ß–ê–¢</button>
        </div>
        
        <div id="contacts-bar">
            </div>

        <div id="chat-window">
            <div id="messages"></div>
            <div class="controls">
                <textarea id="text-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                <div class="btns">
                    <button onclick="sendMsg()">SEND</button>
                    <button onclick="document.getElementById('file').click()">CLIP</button>
                    <button onclick="translateLast()">TR</button>
                </div>
                <input type="file" id="file" style="display:none" onchange="sendFile()">
            </div>
        </div>
    </div>
</div>

<audio id="ooh" src="https://www.soundboard.com/handler/DownLoadTrack.ashx?cliptoken=66738981-d703-4927-993d-d40026e0e643"></audio>

<script>
    let gun, user = {}, currentRoom = null, activeChats = {};
    const ooh = document.getElementById('ooh');

    function login() {
        user.name = document.getElementById('my-name').value;
        user.opentag = document.getElementById('my-opentag').value.trim();
        user.tag = document.getElementById('my-tag').value;

        if(!user.name || !user.opentag || !user.tag) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë!");

        gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://libgun.herokuapp.com/gun']);
        
        document.getElementById('auth-form').style.display = 'none';
        document.getElementById('main-ui').style.display = 'flex';
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ö–æ–¥–∏–º –≤ "–û–±—â–∏–π —á–∞—Ç"
        switchChat('global');
    }

    function startPrivateChat() {
        const target = document.getElementById('search-user').value.trim();
        if(!target || target === user.opentag) return alert("–í–≤–µ–¥–∏—Ç–µ —á—É–∂–æ–π OPEN-TAG");
        switchChat(target);
    }

    function getRoomID(target) {
        if(target === 'global') return 'dnm_global_v2';
        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–æ–º–Ω–∞—Ç—ã –¥–ª—è –¥–≤—É—Ö —é–∑–µ—Ä–æ–≤ (—Å–æ—Ä—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã ID –±—ã–ª –æ–¥–∏–Ω–∞–∫–æ–≤ —É –æ–±–æ–∏—Ö)
        const pair = [user.opentag, target].sort();
        return 'dnm_private_' + pair[0] + '_' + pair[1];
    }

    function switchChat(target) {
        currentRoom = target;
        const roomID = getRoomID(target);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤–∫–ª–∞–¥–æ–∫
        if(!activeChats[target]) {
            activeChats[target] = true;
            const btn = document.createElement('div');
            btn.className = 'contact-tab';
            btn.id = 'tab-' + target;
            btn.innerText = target === 'global' ? 'üåº –û–±—â–∏–π' : '@' + target;
            btn.onclick = () => switchChat(target);
            document.getElementById('contacts-bar').appendChild(btn);
        }

        document.querySelectorAll('.contact-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + target).classList.add('active');
        
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('messages').innerHTML = `<div class="system-msg">–ß–∞—Ç: ${target}</div>`;
        
        listenRoom(roomID);
    }

    function encrypt(d) { return CryptoJS.AES.encrypt(d, user.tag).toString(); }
    function decrypt(d) {
        try { return CryptoJS.AES.decrypt(d, user.tag).toString(CryptoJS.enc.Utf8) || null; } 
        catch(e) { return null; }
    }

    function sendMsg() {
        const t = document.getElementById('text-input').value;
        if(!t.trim()) return;
        const roomID = getRoomID(currentRoom);
        gun.get(roomID).set({ name: user.name, from: user.opentag, msg: encrypt(t), time: Date.now() });
        document.getElementById('text-input').value = "";
    }

    function listenRoom(roomID) {
        const mDiv = document.getElementById('messages');
        const seen = new Set();
        
        gun.get(roomID).map().once((d, id) => {
            if(!d || seen.has(id)) return;
            const dt = decrypt(d.msg);
            if(dt === null && roomID !== 'dnm_global_v2') return; // –í –ø—Ä–∏–≤–∞—Ç–∫–∞—Ö –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—É–∂–æ–µ

            seen.add(id);
            if(d.from !== user.opentag) ooh.play().catch(()=>{});

            const v = document.createElement('div');
            v.className = 'msg';
            const displayMsg = dt || "[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –¥—Ä—É–≥–∏–º –∫–ª—é—á–æ–º]";
            v.innerHTML = `<b>${d.name}:</b> ${displayMsg}`;
            mDiv.appendChild(v);
            mDiv.scrollTop = mDiv.scrollHeight;
        });
    }

    function translateLast() {
        alert("–§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞: –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ Google.");
    }

    function sendFile() {
        const f = document.getElementById('file').files[0];
        if(f && f.size < 1000000) {
            const r = new FileReader();
            r.onload = (e) => {
                const roomID = getRoomID(currentRoom);
                gun.get(roomID).set({ 
                    name: user.name, from: user.opentag, 
                    msg: encrypt("–§–∞–π–ª: " + f.name), 
                    fileData: encrypt(e.target.result), 
                    type: 'media', time: Date.now() 
                });
            };
            r.readAsDataURL(f);
        } else { alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π!"); }
    }
</script>
</body>
                    </html>
